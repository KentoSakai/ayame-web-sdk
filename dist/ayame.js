!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("Ayame",[],e):"object"==typeof exports?exports.Ayame=e():t.Ayame=e()}(window,function(){return function(t){var e={};function n(s){if(e[s])return e[s].exports;var i=e[s]={i:s,l:!1,exports:{}};return t[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(s,i,function(e){return t[e]}.bind(null,i));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";n.r(e);var s=class{constructor(t,e,n){this.roomId=e,this.signalingUrl=t,this.options=n,n.clientId?this.clientId=n.clientId:this.clientId=function(t){for(var e=[];t--;)e.push("0123456789".charAt(Math.floor(Math.random()*"0123456789".length)));return e.join("")}(17),this.stream=null,this._pc=null,this.authnMetadata=null,this._callbacks={connect:()=>{},disconnect:()=>{},addstream:()=>{},removestream:()=>{}}}on(t,e){t in this._callbacks&&(this._callbacks[t]=e)}async connect(t,e=null){return this.stream=t,this._hasReceivedSdp=!1,this._candidates=[],this.authnMetadata=e,this._signaling(),t}disconnect(){this.remoteStreamId=null,this.stream&&this.stream.getTracks().forEach(t=>{t.stop()}),this.stream=null,this._ws.onclose=()=>{},this._ws.close(),this._pc&&"closed"!==this._pc.signalingState&&this._pc.close(),this._pc=null}_signaling(){this._ws=new WebSocket(this.signalingUrl),this._ws.onopen=()=>{const t={type:"register",roomId:this.roomId,clientId:this.clientId,authnMetadata:void 0};null!==this.authnMetadata&&(t.authnMetadata=this.authnMetadata),this._sendWs(t)},this._ws.onclose=async t=>{this.disconnect(),this._callbacks.disconnect(t)},this._ws.onmessage=async t=>{try{if("string"!=typeof t.data)return;const e=JSON.parse(t.data);if("ping"===e.type)this._sendWs({type:"pong"});else if("close"===e.type)this._callbacks.close(t);else if("accept"===e.type)this._pc||(this._pc=this._createPeerConnection()),this._callbacks.connect({authzMetadata:e.authzMetadata}),this._ws.onclose=t=>{this.disconnect(),this._callbacks.disconnect({reason:"WS-CLOSED",event:t})};else if("reject"===e.type)this.disconnect(),this._callbacks.disconnect({reason:"REJECTED"});else if("offer"===e.type){const t=new window.RTCSessionDescription(e);this._setOffer(t)}else if("answer"===e.type){const t=new window.RTCSessionDescription(e);await this._setAnswer(t)}else if("candidate"===e.type&&e.ice){const t=new window.RTCIceCandidate(e.ice);this._hasReceivedSdp?this._addIceCandidate(t):this._candidates.push(t)}}catch(t){this.disconnect(),this._callbacks.disconnect({reason:"SIGNALING-ERROR",error:t})}}}_createPeerConnection(){const t={iceServers:this.options.iceServers},e=new window.RTCPeerConnection(t);return"ontrack"in e?e.ontrack=t=>{const e=t.streams[0];e&&"default"!==e.id&&(this.remoteStreamId=e.id,t.stream=e,this._callbacks.addstream(t))}:(e.onaddstream=t=>{const e=t.stream;(this.remoteStreamId&&e.id!==this.remoteStreamId||null===this.remoteStreamId)&&(this.remoteStreamId=e.id,this._callbacks.addstream(t))},e.onremovestream=t=>{this.remoteStreamId&&t.stream.id===this.remoteStreamId&&(this.remoteStreamId=null,this._callbacks.removestream(t))}),e.onicecandidate=t=>{t.candidate&&this._sendIceCandidate(t.candidate)},e.oniceconnectionstatechange=()=>{e.iceConnectionState},e.onnegotiationneeded=async()=>{try{const t=await e.createOffer({offerToReceiveAudio:this.options.audio,offerToReceiveVideo:this.options.video});await e.setLocalDescription(t),this._sendSdp(e.localDescription)}catch(t){this.disconnect(),this._callbacks.disconnect({reason:"NEGOTIATION-ERROR",error:t})}},this.stream&&(void 0===e.addStream?this.stream.getTracks().forEach(t=>{e.addTrack(t,this.stream)}):e.addStream(this.stream)),function(t){const e=t.getConfiguration();return"addTransceiver"in t&&(!("sdpSemantics"in e)||"unified-plan"===e.sdpSemantics)}(e)&&(e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"})),e}async _createAnswer(){if(this._pc)try{let t=await this._pc.createAnswer();await this._pc.setLocalDescription(t),this._sendSdp(this._pc.localDescription)}catch(t){this.disconnect(),this._callbacks.disconnect({reason:"CREATE-ANSWER-ERROR",error:t})}}async _setAnswer(t){await this._pc.setRemoteDescription(t),this._drainCandidate()}async _setOffer(t){this._pc=this._createPeerConnection(),this._pc.onnegotiationneeded=()=>{};try{await this._pc.setRemoteDescription(t),await this._createAnswer()}catch(t){this.disconnect(),this._callbacks.disconnect({reason:"SET-OFFER-ERROR",error:t})}}_addIceCandidate(t){this._pc.addIceCandidate(t)}_drainCandidate(){this._hasReceivedSdp=!0,this._candidates.forEach(t=>{this._addIceCandidate(t)}),this._candidates=[]}_sendIceCandidate(t){const e={type:"candidate",ice:t};this._sendWs(e)}_sendSdp(t){this._sendWs(t)}_sendWs(t){this._ws&&this._ws.send(JSON.stringify(t))}};n.d(e,"connection",function(){return a}),n.d(e,"version",function(){return c});const i={audio:!0,video:!0,iceServers:[{urls:"stun:stun.l.google.com:19302"}]};function a(t,e,n=i){return new s(t,e,n)}function c(){return"0.0.1-rc2"}}])});