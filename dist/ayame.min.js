!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Ayame",[],t):"object"==typeof exports?exports.Ayame=t():e.Ayame=t()}(window,function(){return function(e){var t={};function n(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(s,i,function(t){return e[t]}.bind(null,i));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);var s=class{constructor(e,t,n){this.roomId=t,this.signalingUrl=e,this.options=n,n.clientId?this.clientId=n.clientId:this.clientId=function(e){for(var t=[];e--;)t.push("0123456789".charAt(Math.floor(Math.random()*"0123456789".length)));return t.join("")}(17),this.stream=null,this._pc=null,this.authnMetadata=null,this._callbacks={connect:()=>{},disconnect:()=>{},addstream:()=>{},removestream:()=>{}}}on(e,t){e in this._callbacks&&(this._callbacks[e]=t)}async connect(e,t=null){return this.stream=e,this.authnMetadata=t,this._signaling(),e}disconnect(){this.remoteStreamId=null,this.stream&&this.stream.getTracks().forEach(e=>{e.stop()}),this.stream=null,this._ws.onclose=()=>{},this._ws.close(),this._pc&&"closed"!==this._pc.signalingState&&this._pc.close(),this._pc=null}_signaling(){this._ws=new WebSocket(this.signalingUrl),this._ws.onopen=()=>{this._pc||(this._pc=this._createPeerConnection());const e={type:"register",roomId:this.roomId,clientId:this.clientId,authnMetadata:void 0};null!==this.authnMetadata&&(e.authnMetadata=this.authnMetadata),this._sendWs(e)},this._ws.onclose=async e=>{this.disconnect(),this._callbacks.disconnect(e)},this._ws.onmessage=async e=>{try{if("string"!=typeof e.data)return;const t=JSON.parse(e.data);if("ping"===t.type)this._sendWs({type:"pong"});else if("close"===t.type)this._callbacks.close(e);else if("accept"===t.type)this._callbacks.connect({authzMetadata:t.authzMetadata}),this._ws.onclose=e=>{this.disconnect(),this._callbacks.disconnect({reason:"WS-CLOSED",event:e})};else if("reject"===t.type)this.disconnect(),this._callbacks.disconnect({reason:"REJECTED"});else if("offer"===t.type){const e=new window.RTCSessionDescription(t);this._setOffer(e)}else if("answer"===t.type){const e=new window.RTCSessionDescription(t);await this._setAnswer(e)}else if("candidate"===t.type&&t.ice){const e=new window.RTCIceCandidate(t.ice);this._addIceCandidate(e)}}catch(e){this.disconnect(),this._callbacks.disconnect({reason:"SIGNALING-ERROR",error:e})}}}_createPeerConnection(){const e={iceServers:this.options.iceServers},t=new window.RTCPeerConnection(e);void 0===t.ontrack?(t.onaddstream=e=>{const t=e.stream;(this.remoteStreamId&&t.id!==this.remoteStreamId||null===this.remoteStreamId)&&(this.remoteStreamId=t.id,this._callbacks.addstream(e))},t.onremovestream=e=>{this.remoteStreamId&&e.stream.id===this.remoteStreamId&&(this.remoteStreamId=null,this._callbacks.removestream(e))}):t.ontrack=e=>{const t=e.streams[0];t&&"default"!==t.id&&t.id!==(this.stream&&this.stream.id)&&(this.remoteStreamId=t.id,e.stream=t,this._callbacks.addstream(e))},t.onicecandidate=e=>{e.candidate&&this._sendIceCandidate(e.candidate)},t.oniceconnectionstatechange=()=>{t.iceConnectionState},t.onnegotiationneeded=async()=>{try{const e=await t.createOffer({offerToReceiveAudio:this.options.audio.enabled,offerToReceiveVideo:this.options.video.enabled});await t.setLocalDescription(e),this._sendSdp(t.localDescription)}catch(e){this.disconnect(),this._callbacks.disconnect({reason:"NEGOTIATION-ERROR",error:e})}};const n=this.stream&&this.stream.getVideoTracks()[0],s=this.stream&&this.stream.getAudioTracks()[0];return s&&t.addTransceiver(s,{streams:[this.stream],direction:this.options.audio.direction}),t.addTransceiver("audio",{direction:"recvonly"}),n&&t.addTransceiver(n,{streams:[this.stream],direction:this.options.video.direction}),t.addTransceiver("video",{direction:"recvonly"}),"sendonly"===this.options.video.direction&&t.getTransceivers().forEach(e=>{n&&e.sender.replaceTrack(n),e.direction="sendonly"}),"sendonly"===this.options.audio.direction&&t.getTransceivers().forEach(e=>{s&&e.sender.replaceTrack(s),e.direction="sendonly"}),t}async _createAnswer(){if(this._pc)try{let e=await this._pc.createAnswer();await this._pc.setLocalDescription(e),this._sendSdp(this._pc.localDescription)}catch(e){this.disconnect(),this._callbacks.disconnect({reason:"CREATE-ANSWER-ERROR",error:e})}}async _setAnswer(e){await this._pc.setRemoteDescription(e)}async _setOffer(e){this._pc||(this._pc=this._createPeerConnection()),this._pc.onnegotiationneeded=()=>{};try{await this._pc.setRemoteDescription(e),await this._createAnswer()}catch(e){this.disconnect(),this._callbacks.disconnect({reason:"SET-OFFER-ERROR",error:e})}}_addIceCandidate(e){this._pc&&this._pc.addIceCandidate(e)}_sendIceCandidate(e){const t={type:"candidate",ice:e};this._sendWs(t)}_sendSdp(e){this._sendWs(e)}_sendWs(e){console.log(e),this._ws&&this._ws.send(JSON.stringify(e))}};n.d(t,"connection",function(){return c}),n.d(t,"version",function(){return o});const i={audio:{direction:"sendrecv",enabled:!0},video:{direction:"sendrecv",enabled:!0},iceServers:[{urls:"stun:stun.l.google.com:19302"}]};function c(e,t,n=i){return new s(e,t,n)}function o(){return"0.0.1-rc2"}}])});